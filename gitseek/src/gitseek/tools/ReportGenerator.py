from crewai.tools import BaseTool
from typing import Type, Dict, Any, List
from pydantic import BaseModel, Field
from datetime import datetime
from typing import ClassVar
import json
import os


class ReportGenerationInput(BaseModel):
    """Input schema for ReportGenerator."""
    project_data: Dict = Field(..., description="èšåˆçš„é¡¹ç›®åˆ†ææ•°æ®")
    output_path: str = Field(default="output/report.md", description="æŠ¥å‘Šè¾“å‡ºè·¯å¾„")
    generate_qa: bool = Field(default=True, description="æ˜¯å¦ç”Ÿæˆ QA æ•°æ®é›†")


class ReportGenerator(BaseTool):
    name: str = "Technical Report Generator"
    description: str = """å°†æ‰€æœ‰åˆ†æç»“æœæ•´åˆä¸ºç»“æ„åŒ–çš„ Markdown æŠ€æœ¯æŠ¥å‘Šã€‚
    åŒæ—¶å¯ä»¥ç”Ÿæˆ QA è®­ç»ƒæ•°æ®é›†ç”¨äºæ¨¡å‹å¾®è°ƒã€‚"""
    args_schema: Type[BaseModel] = ReportGenerationInput

    

    REPORT_TEMPLATE: ClassVar[str] = """# {project_name} - æŠ€æœ¯åˆ†ææŠ¥å‘Š

**ç”Ÿæˆæ—¶é—´:** {timestamp}  
**ä»“åº“åœ°å€:** [{repo_url}]({repo_url})  
**åˆ†æå·¥å…·:** GitSeek v1.0  
**ä¸»è¦è¯­è¨€:** {main_language}

---

## ğŸ“Š æ‰§è¡Œæ‘˜è¦

{executive_summary}

**å…³é”®æŒ‡æ ‡:**
- â­ Stars: {stars}
- ğŸ´ Forks: {forks}
- ğŸ‘¥ Contributors: {contributors}
- ğŸ“ˆ å¥åº·åº¦è¯„åˆ†: {health_score}/100

---

## 1ï¸âƒ£ é¡¹ç›®æ¦‚è§ˆ

### åŸºæœ¬ä¿¡æ¯

| å±æ€§ | å€¼ |
|------|-----|
| **é¡¹ç›®åç§°** | {project_name} |
| **å®Œæ•´è·¯å¾„** | {full_name} |
| **ä¸»è¦è¯­è¨€** | {main_language} |
| **è®¸å¯è¯** | {license} |
| **åˆ›å»ºæ—¶é—´** | {created_at} |
| **æœ€åæ›´æ–°** | {updated_at} |
| **ä»“åº“å¤§å°** | {size} KB |

### é¡¹ç›®æè¿°

{description}

### æŠ€æœ¯æ ˆæ ‡ç­¾

{topics}

---

## 2ï¸âƒ£ æ¶æ„åˆ†æ

### 2.1 ç›®å½•ç»“æ„

{directory_structure}

### 2.2 æ ¸å¿ƒæ¨¡å—è¯†åˆ«

{core_modules}

### 2.3 é…ç½®æ–‡ä»¶åˆ†æ

{config_files}

### 2.4 ä¾èµ–å…³ç³»

{dependencies}

### 2.5 æ¶æ„è¯„ä¼°

{architecture_assessment}

---

## 3ï¸âƒ£ ä»£ç è´¨é‡è¯„ä¼°

### 3.1 å®¡æŸ¥çš„å…³é”®æ–‡ä»¶

{reviewed_files}

### 3.2 ä»£ç è´¨é‡æŒ‡æ ‡

{code_quality_metrics}

### 3.3 è¯†åˆ«çš„è®¾è®¡æ¨¡å¼

{design_patterns}

### 3.4 ä»£ç å¤æ‚åº¦åˆ†æ

{code_complexity}

### 3.5 æ”¹è¿›å»ºè®®

{code_recommendations}

---

## 4ï¸âƒ£ ç¤¾åŒºåŠ¨æ€åˆ†æ

### 4.1 ç¤¾åŒºå¥åº·åº¦

{community_health}

### 4.2 Issues åˆ†æ

{issue_analysis}

### 4.3 Pull Requests åˆ†æ

{pr_analysis}

### 4.4 ä¸»è¦è´¡çŒ®è€…

{contributors_analysis}

### 4.5 æ´»è·ƒåº¦è¶‹åŠ¿

{activity_trends}

---

## 5ï¸âƒ£ ç»¼åˆè¯„ä¼°ä¸å»ºè®®

### 5.1 é¡¹ç›®ä¼˜åŠ¿

{project_strengths}

### 5.2 å¾…æ”¹è¿›é¢†åŸŸ

{improvement_areas}

### 5.3 æˆ˜ç•¥å»ºè®®

{strategic_recommendations}

### 5.4 æŠ€æœ¯å€ºåŠ¡è¯„ä¼°

{technical_debt}

---

## ğŸ“ˆ æ€»ç»“

{conclusion}

---

**æŠ¥å‘Šç»“æŸ | Report Generated by GitSeek**

---

## é™„å½•ï¼šåˆ†æå…ƒæ•°æ®

- **åˆ†ææ—¥æœŸ:** {timestamp}
- **åˆ†æå·¥å…·ç‰ˆæœ¬:** GitSeek v1.0
- **æ•°æ®æ¥æº:** GitHub API + æœ¬åœ°ä»£ç æ‰«æ
- **åˆ†æèŒƒå›´:** å®Œæ•´ä»“åº“åˆ†æ
"""

    def _run(self, project_data: Dict, output_path: str = "output/report.md", generate_qa: bool = True) -> Dict[str, Any]:
        """ç”Ÿæˆå®Œæ•´çš„æŠ€æœ¯åˆ†ææŠ¥å‘Š"""
        try:
            # ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
            os.makedirs(os.path.dirname(output_path) if os.path.dirname(output_path) else ".", exist_ok=True)
            
             # ğŸ”¥ æ–°å¢ï¼šå¦‚æœ project_data ä¸ºç©ºï¼Œä¸»åŠ¨è¯»å–æ•°æ®æ–‡ä»¶
            if not project_data or not project_data.get('metadata'):
                print("ğŸ” æ£€æµ‹åˆ°ç©ºæ•°æ®ï¼Œå¼€å§‹ä»æ–‡ä»¶åŠ è½½...")
                project_data = self._load_data_from_files()

            # æ£€æŸ¥æ•°æ®æ˜¯å¦åŠ è½½æˆåŠŸ
            if not project_data.get('metadata'):
                error_msg = "âŒ æ— æ³•è·å–é¡¹ç›®æ•°æ®ï¼Œè¯·ç¡®ä¿å‰ç½®ä»»åŠ¡å·²æ­£ç¡®æ‰§è¡Œå¹¶ç”Ÿæˆæ•°æ®æ–‡ä»¶"
                print(error_msg)
                return {"success": False, "error": error_msg}
            
            print(f"âœ… æˆåŠŸåŠ è½½é¡¹ç›®æ•°æ®: {project_data['metadata'].get('name', 'Unknown')}")

            # æå–å„éƒ¨åˆ†æ•°æ®
            metadata = project_data.get('metadata', {})
            architecture = project_data.get('architecture', {})
            code_review = project_data.get('code_review', {})
            community = project_data.get('community', {})
            
            # ç”ŸæˆæŠ¥å‘Šå†…å®¹
            report_content = self.REPORT_TEMPLATE.format(
                project_name=metadata.get('name', 'Unknown Project'),
                timestamp=datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                repo_url=metadata.get('html_url', ''),
                main_language=metadata.get('language', 'N/A'),
                full_name=metadata.get('full_name', 'N/A'),
                stars=metadata.get('stars', 0),
                forks=metadata.get('forks', 0),
                contributors=community.get('total_contributors', 0),
                health_score=community.get('health_score', 0),
                executive_summary=self._generate_executive_summary(project_data),
                description=metadata.get('description', 'No description available.'),
                topics=self._format_topics(metadata.get('topics', [])),
                license=metadata.get('license', 'No license'),
                created_at=self._format_date(metadata.get('created_at')),
                updated_at=self._format_date(metadata.get('updated_at')),
                size=metadata.get('size', 0),
                directory_structure=self._format_directory_structure(architecture),
                core_modules=self._format_core_modules(architecture),
                config_files=self._format_config_files(architecture),
                dependencies=self._format_dependencies(architecture),
                architecture_assessment=self._assess_architecture(architecture),
                reviewed_files=self._format_reviewed_files(code_review),
                code_quality_metrics=self._format_quality_metrics(code_review),
                design_patterns=self._format_design_patterns(code_review),
                code_complexity=self._format_code_complexity(code_review),
                code_recommendations=self._format_code_recommendations(code_review),
                community_health=self._format_community_health(community),
                issue_analysis=self._format_issue_analysis(community),
                pr_analysis=self._format_pr_analysis(community),
                contributors_analysis=self._format_contributors(community),
                activity_trends=self._format_activity_trends(metadata, community),
                project_strengths=self._identify_strengths(project_data),
                improvement_areas=self._identify_improvements(project_data),
                strategic_recommendations=self._generate_strategic_recommendations(project_data),
                technical_debt=self._assess_technical_debt(code_review),
                conclusion=self._generate_conclusion(project_data)
            )
            
            # å†™å…¥æŠ¥å‘Šæ–‡ä»¶
            with open(output_path, 'w', encoding='utf-8') as f:
                f.write(report_content)
            
            result = {
                "success": True,
                "report_path": output_path,
                "report_size": len(report_content),
                "timestamp": datetime.now().isoformat()
            }
            
            # ç”Ÿæˆ QA æ•°æ®é›†
            if generate_qa:
                qa_path = output_path.replace('.md', '_qa_dataset.json')
                qa_dataset = self._generate_qa_dataset(project_data)
                
                with open(qa_path, 'w', encoding='utf-8') as f:
                    json.dump(qa_dataset, f, ensure_ascii=False, indent=2)
                
                result['qa_dataset_path'] = qa_path
                result['qa_pairs_count'] = len(qa_dataset)
            
            return result
            
        except Exception as e:
            return {"success": False, "error": f"æŠ¥å‘Šç”Ÿæˆå¤±è´¥: {str(e)}"}
    
        # ğŸ”¥ æ–°å¢ï¼šæ–‡ä»¶è¯»å–æ–¹æ³•
    def _load_data_from_files(self) -> Dict[str, Any]:
        """ä»æ•°æ®æ–‡ä»¶åŠ è½½é¡¹ç›®æ•°æ®"""
        data = {
            'metadata': {},
            'architecture': {},
            'code_review': {},
            'community': {}
        }
        
        try:
            # è¯»å–ä¾¦å¯Ÿæ•°æ®
            if os.path.exists('output/scout_data.json'):
                with open('output/scout_data.json', 'r', encoding='utf-8') as f:
                    scout_data = json.load(f)
                    data['metadata'] = scout_data.get('metadata', {})
                    print(f"âœ… åŠ è½½å…ƒæ•°æ®: {data['metadata'].get('name', 'Unknown')} - {data['metadata'].get('stars', 0)} stars")
            
            # è¯»å–æ¶æ„æ•°æ®
            if os.path.exists('output/architect_data.json'):
                with open('output/architect_data.json', 'r', encoding='utf-8') as f:
                    arch_data = json.load(f)
                    data['architecture'] = arch_data
                    core_dirs = arch_data.get('core_directories', [])
                    print(f"âœ… åŠ è½½æ¶æ„æ•°æ®: {len(core_dirs)} ä¸ªæ ¸å¿ƒç›®å½•")
            
            # è¯»å–ä»£ç å®¡æŸ¥æ•°æ®
            if os.path.exists('output/code_review_data.json'):
                with open('output/code_review_data.json', 'r', encoding='utf-8') as f:
                    code_data = json.load(f)
                    data['code_review'] = code_data
                    avg_score = code_data.get('average_score', 'N/A')
                    print(f"âœ… åŠ è½½ä»£ç æ•°æ®: å¹³å‡åˆ† {avg_score}")
            
            # è¯»å–ç¤¾åŒºæ•°æ®
            if os.path.exists('output/community_data.json'):
                with open('output/community_data.json', 'r', encoding='utf-8') as f:
                    community_data = json.load(f)
                    data['community'] = community_data
                    health_score = community_data.get('health_score', 'N/A')
                    print(f"âœ… åŠ è½½ç¤¾åŒºæ•°æ®: å¥åº·åº¦ {health_score}")
            
            # æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
            missing_sections = []
            if not data['metadata']:
                missing_sections.append('metadata')
            if not data['architecture']:
                missing_sections.append('architecture')
            if not data['code_review']:
                missing_sections.append('code_review') 
            if not data['community']:
                missing_sections.append('community')
                
            if missing_sections:
                print(f"âš ï¸ ç¼ºå¤±æ•°æ®éƒ¨åˆ†: {missing_sections}")
            else:
                print("âœ… æ‰€æœ‰æ•°æ®æ–‡ä»¶åŠ è½½å®Œæˆ")
                
        except Exception as e:
            print(f"âŒ è¯»å–æ•°æ®æ–‡ä»¶å¤±è´¥: {e}")
            import traceback
            traceback.print_exc()
        
        return data
        
    # === æŠ¥å‘Šå†…å®¹ç”Ÿæˆæ–¹æ³• ===
    
    def _generate_executive_summary(self, data: Dict) -> str:
        """ç”Ÿæˆæ‰§è¡Œæ‘˜è¦"""
        metadata = data.get('metadata', {})
        community = data.get('community', {})
        code_review = data.get('code_review', {})
        
        activity_level = community.get('activity_level', 'æœªçŸ¥')
        health_score = community.get('health_score', 0)
        
        return f"""æœ¬æŠ¥å‘Šå¯¹ **{metadata.get('name', 'Unknown')}** é¡¹ç›®è¿›è¡Œäº†å…¨é¢çš„æŠ€æœ¯åˆ†æã€‚

**åˆ†æè¦†ç›–èŒƒå›´:**
- âœ… é¡¹ç›®åŸºæœ¬ä¿¡æ¯å’Œå…ƒæ•°æ®æ”¶é›†
- âœ… æ–‡ä»¶æ¶æ„å’Œä¾èµ–å…³ç³»åˆ†æ
- âœ… ä»£ç è´¨é‡å’Œè®¾è®¡æ¨¡å¼è¯„ä¼°
- âœ… ç¤¾åŒºæ´»è·ƒåº¦å’Œè´¡çŒ®è€…åˆ†æ

**æ ¸å¿ƒå‘ç°:**
- è¯¥é¡¹ç›®ç›®å‰å¤„äº **{activity_level}** çŠ¶æ€
- ç¤¾åŒºå¥åº·åº¦è¯„åˆ†ä¸º **{health_score}/100**
- ä»£ç è´¨é‡è¯„ä¼°ä¸º **{code_review.get('overall_quality', 'N/A')}**
- ä¸»è¦ä½¿ç”¨ **{metadata.get('language', 'N/A')}** è¯­è¨€å¼€å‘
"""

    def _format_topics(self, topics: List[str]) -> str:
        """æ ¼å¼åŒ–æŠ€æœ¯æ ˆæ ‡ç­¾"""
        if not topics:
            return "æš‚æ— æ ‡ç­¾"
        return ", ".join([f"`{topic}`" for topic in topics])

    def _format_date(self, date_str: str) -> str:
        """æ ¼å¼åŒ–æ—¥æœŸ"""
        if not date_str:
            return "N/A"
        try:
            dt = datetime.fromisoformat(date_str.replace('Z', '+00:00'))
            return dt.strftime("%Y-%m-%d %H:%M")
        except:
            return date_str

    def _format_directory_structure(self, arch: Dict) -> str:
        """æ ¼å¼åŒ–ç›®å½•ç»“æ„"""
        structure = arch.get('structure', {})
        if not structure:
            return "ç›®å½•ç»“æ„æ•°æ®æœªè·å–"
        
        # ğŸ”¥ ä¿®æ”¹ï¼šé€‚é…å®é™…çš„æ•°æ®ç»“æ„
        root = structure.get('root', {})
        items = root.get('items', [])
        
        result = "```\n"
        for item in items[:8]:  # æ˜¾ç¤ºå‰8ä¸ªä¸»è¦ç›®å½•
            name = item.get('name', '')
            desc = item.get('description', '')
            if desc:
                result += f"{name}/     # {desc}\n"
            else:
                result += f"{name}/\n"
        result += "```\n\n"
        
        core_dirs = arch.get('core_directories', [])
        if core_dirs:
            result += f"**æ ¸å¿ƒç›®å½•:** {', '.join(core_dirs)}"
        
        return result

    def _format_core_modules(self, arch: Dict) -> str:
        """æ ¼å¼åŒ–æ ¸å¿ƒæ¨¡å—"""
        core_dirs = arch.get('core_directories', [])
        if not core_dirs:
            return "æœªè¯†åˆ«åˆ°æ˜ç¡®çš„æ ¸å¿ƒæ¨¡å—"
        
        result = "è¯†åˆ«åˆ°ä»¥ä¸‹æ ¸å¿ƒæ¨¡å—:\n\n"
        for idx, dir_name in enumerate(core_dirs, 1):
            result += f"{idx}. **{dir_name}** - æ ¸å¿ƒä»£ç æ¨¡å—\n"
        
        return result

    def _format_config_files(self, arch: Dict) -> str:
        """æ ¼å¼åŒ–é…ç½®æ–‡ä»¶"""
        config_files = arch.get('config_files', [])
        if not config_files:
            return "æœªæ‰¾åˆ°é…ç½®æ–‡ä»¶"
        
        result = "| é…ç½®æ–‡ä»¶ | ç±»å‹ | æè¿° |\n|---------|------|------|\n"
        for config in config_files[:10]:
            # ğŸ”¥ ä¿®æ”¹ï¼šé€‚é…å®é™…çš„æ•°æ®ç»“æ„
            path = config.get('path', '')
            file_name = os.path.basename(path)
            file_type = config.get('type', self._identify_config_type(file_name))
            description = config.get('description', '')
            result += f"| `{file_name}` | {file_type} | {description} |\n"
        
        if len(config_files) > 10:
            result += f"\n*... ä»¥åŠå…¶ä»– {len(config_files) - 10} ä¸ªé…ç½®æ–‡ä»¶*\n"
        
        return result

    def _format_dependencies(self, arch: Dict) -> str:
        """æ ¼å¼åŒ–ä¾èµ–å…³ç³»"""
        deps = arch.get('dependencies', {})
        if not deps:
            return "ä¾èµ–å…³ç³»æ•°æ®æœªè·å–"
        
        # ğŸ”¥ ä¿®æ”¹ï¼šæ˜¾ç¤ºå®é™…çš„ä¾èµ–æ•°æ®
        result = "**ä¸»è¦ä¾èµ–:**\n\n"
        
        python_deps = deps.get('python', {})
        if python_deps:
            result += "**Python ä¾èµ–:**\n"
            for category, packages in python_deps.items():
                result += f"- {category}: {len(packages)} ä¸ªåŒ…\n"
            result += "\n"
        
        js_deps = deps.get('javascript', {})
        if js_deps:
            result += "**JavaScript ä¾èµ–:**\n"
            for category, packages in js_deps.items():
                result += f"- {category}: {len(packages)} ä¸ªåŒ…\n"
        
        return result

    def _format_reviewed_files(self, code_review: Dict) -> str:
        """æ ¼å¼åŒ–å®¡æŸ¥çš„æ–‡ä»¶åˆ—è¡¨"""
        files = code_review.get('reviewed_files', [])
        if not files:
            return "æš‚æ— ä»£ç å®¡æŸ¥æ•°æ®"
        
        result = "| æ–‡ä»¶ | è¯­è¨€ | ä»£ç è¡Œæ•° | è´¨é‡è¯„åˆ† |\n"
        result += "|------|------|----------|----------|\n"
        
        for file_info in files[:8]:  # æ˜¾ç¤ºå‰8ä¸ªæ–‡ä»¶
            file_path = file_info.get('file_path', '')
            file_name = os.path.basename(file_path)
            reason = file_info.get('selection_reason', '')[:50] + "..." if len(file_info.get('selection_reason', '')) > 50 else file_info.get('selection_reason', '')
            analysis = file_info.get('analysis', {})
            score = analysis.get('overall_score', 'N/A')
            
            result += f"| `{file_name}` | {reason} | {score}/100 |\n"
        
        return result

    def _format_quality_metrics(self, code_review: Dict) -> str:
        """æ ¼å¼åŒ–ä»£ç è´¨é‡æŒ‡æ ‡"""
        return f"""**æ€»ä½“è¯„ä¼°:**
- å¹³å‡è´¨é‡è¯„åˆ†: {code_review.get('average_score', 'N/A')}/100
- ä»£ç å¯è¯»æ€§: {code_review.get('readability', 'N/A')}
- æ³¨é‡Šè¦†ç›–ç‡: {code_review.get('comment_coverage', 'N/A')}%
"""

    def _format_design_patterns(self, code_review: Dict) -> str:
        """æ ¼å¼åŒ–è®¾è®¡æ¨¡å¼"""
        patterns_data = code_review.get('design_patterns', [])
        if not patterns_data:
            return "æœªæ£€æµ‹åˆ°æ˜æ˜¾çš„è®¾è®¡æ¨¡å¼"
        
        # ğŸ”¥ ä¿®æ”¹ï¼šé€‚é…å®é™…çš„æ•°æ®ç»“æ„
        if isinstance(patterns_data, list) and patterns_data and isinstance(patterns_data[0], dict):
            # æ–°çš„æ•°æ®ç»“æ„ï¼šåˆ—è¡¨ä¸­çš„å­—å…¸
            result = "è¯†åˆ«åˆ°ä»¥ä¸‹è®¾è®¡æ¨¡å¼:\n\n"
            for pattern_info in patterns_data:
                pattern = pattern_info.get('pattern', '')
                usage = pattern_info.get('usage', '')
                files = pattern_info.get('files', [])
                result += f"- **{pattern}**: {usage} (æ–‡ä»¶: {', '.join(files[:3])})\n"
        else:
            # æ—§çš„æ•°æ®ç»“æ„ï¼šç®€å•çš„å­—ç¬¦ä¸²åˆ—è¡¨
            result = "è¯†åˆ«åˆ°ä»¥ä¸‹è®¾è®¡æ¨¡å¼:\n\n"
            for pattern in set(patterns_data):
                result += f"- {pattern}\n"
        
        return result

    def _format_code_complexity(self, code_review: Dict) -> str:
        """æ ¼å¼åŒ–ä»£ç å¤æ‚åº¦"""
        return f"""**å¤æ‚åº¦æŒ‡æ ‡:**
- å¹³å‡åœˆå¤æ‚åº¦: {code_review.get('avg_complexity', 'N/A')}
- å¯ç»´æŠ¤æ€§æŒ‡æ•°: {code_review.get('maintainability_index', 'N/A')}/100
"""

    def _format_code_recommendations(self, code_review: Dict) -> str:
        """æ ¼å¼åŒ–ä»£ç æ”¹è¿›å»ºè®®"""
        recommendations = code_review.get('recommendations', [])
        if not recommendations:
            return "ä»£ç è´¨é‡è‰¯å¥½ï¼Œæš‚æ— é‡å¤§æ”¹è¿›å»ºè®®"
        
        result = ""
        for idx, rec in enumerate(recommendations, 1):
            result += f"{idx}. {rec}\n"
        
        return result

    def _format_community_health(self, community: Dict) -> str:
        """æ ¼å¼åŒ–ç¤¾åŒºå¥åº·åº¦"""
        return f"""**å¥åº·åº¦è¯„åˆ†:** {community.get('health_score', 0)}/100

**å…³é”®æŒ‡æ ‡:**
- æ´»è·ƒåº¦ç­‰çº§: {community.get('activity_level', 'N/A')}
- ç¤¾åŒºå‚ä¸åº¦: {community.get('community_engagement', 'N/A')}
- Issue å…³é—­ç‡: {community.get('issue_closure_rate', 0)}%
- PR åˆå¹¶ç‡: {community.get('pr_merge_rate', 0)}%
"""

    def _format_issue_analysis(self, community: Dict) -> str:
        """æ ¼å¼åŒ– Issue åˆ†æ"""
        issues = community.get('issues', {})
        return f"""**ç»Ÿè®¡æ•°æ®:**
- Open Issues: {issues.get('open_issues', 0)}
- Closed Issues: {issues.get('closed_issues', 0)}
- å…³é—­ç‡: {issues.get('closure_rate', 0)}%

**çƒ­ç‚¹é—®é¢˜:**
{self._format_hot_issues(issues.get('hot_issues', []))}
"""

    def _format_hot_issues(self, hot_issues: List[Dict]) -> str:
        """æ ¼å¼åŒ–çƒ­ç‚¹é—®é¢˜"""
        if not hot_issues:
            return "æš‚æ— çƒ­ç‚¹é—®é¢˜"
        
        result = ""
        for issue in hot_issues[:5]:
            result += f"- #{issue.get('number')}: {issue.get('title')} ({issue.get('comments')} è¯„è®º)\n"
        
        return result

    def _format_pr_analysis(self, community: Dict) -> str:
        """æ ¼å¼åŒ– PR åˆ†æ"""
        prs = community.get('prs', {})
        return f"""**ç»Ÿè®¡æ•°æ®:**
- Merged PRs: {prs.get('merged_prs', 0)}
- Open PRs: {prs.get('open_prs', 0)}
- åˆå¹¶ç‡: {prs.get('merge_rate', 0)}%

**ä»£ç å˜æ›´:**
- æ€»æ–°å¢è¡Œæ•°: {prs.get('total_additions', 0)}
- æ€»åˆ é™¤è¡Œæ•°: {prs.get('total_deletions', 0)}
"""

    def _format_contributors(self, community: Dict) -> str:
        """æ ¼å¼åŒ–è´¡çŒ®è€…ä¿¡æ¯"""
        contributors = community.get('top_contributors', [])
        if not contributors:
            return "æš‚æ— è´¡çŒ®è€…æ•°æ®"
        
        result = "| æ’å | è´¡çŒ®è€… | è´¡çŒ®æ¬¡æ•° |\n|------|--------|----------|\n"
        for contrib in contributors[:10]:
            result += f"| {contrib.get('rank', 'N/A')} | {contrib.get('login', 'N/A')} | {contrib.get('contributions', 0)} |\n"
        
        return result

    def _format_activity_trends(self, metadata: Dict, community: Dict) -> str:
        """æ ¼å¼åŒ–æ´»è·ƒåº¦è¶‹åŠ¿"""
        return f"""åŸºäºæœ€è¿‘æ›´æ–°æ—¶é—´å’Œç¤¾åŒºæ´»åŠ¨:
- æœ€åæ›´æ–°: {self._format_date(metadata.get('updated_at'))}
- æ´»è·ƒåº¦: {community.get('activity_level', 'æœªçŸ¥')}
"""

    def _identify_strengths(self, data: Dict) -> str:
        """è¯†åˆ«é¡¹ç›®ä¼˜åŠ¿"""
        strengths = []
        
        metadata = data.get('metadata', {})
        community = data.get('community', {})
        
        if metadata.get('stars', 0) > 100:
            strengths.append("âœ… å—åˆ°ç¤¾åŒºå¹¿æ³›å…³æ³¨ (Stars > 100)")
        
        if community.get('health_score', 0) > 70:
            strengths.append("âœ… ç¤¾åŒºå¥åº·åº¦é«˜")
        
        if community.get('activity_level', '').startswith('æ´»è·ƒ'):
            strengths.append("âœ… é¡¹ç›®ä¿æŒæ´»è·ƒå¼€å‘")
        
        return "\n".join(strengths) if strengths else "å¾…è¿›ä¸€æ­¥åˆ†æ"

    def _identify_improvements(self, data: Dict) -> str:
        """è¯†åˆ«å¾…æ”¹è¿›é¢†åŸŸ"""
        improvements = []
        
        community = data.get('community', {})
        code_review = data.get('code_review', {})
        
        if community.get('issue_closure_rate', 0) < 50:
            improvements.append("âš ï¸ Issue å…³é—­ç‡è¾ƒä½ï¼Œéœ€è¦æ”¹è¿›é—®é¢˜å“åº”")
        
        if community.get('pr_merge_rate', 0) < 50:
            improvements.append("âš ï¸ PR åˆå¹¶ç‡è¾ƒä½ï¼Œå»ºè®®ä¼˜åŒ–å®¡æŸ¥æµç¨‹")
        
        if code_review.get('average_score', 100) < 70:
            improvements.append("âš ï¸ ä»£ç è´¨é‡æœ‰å¾…æå‡")
        
        return "\n".join(improvements) if improvements else "æ— æ˜æ˜¾å¾…æ”¹è¿›é¡¹"

    def _generate_strategic_recommendations(self, data: Dict) -> str:
        """ç”Ÿæˆæˆ˜ç•¥å»ºè®®"""
        return """**å»ºè®®ä¼˜å…ˆçº§:**

1. **çŸ­æœŸ (1-3ä¸ªæœˆ):**
   - æ”¹è¿›æ–‡æ¡£è´¨é‡
   - å¢åŠ å•å…ƒæµ‹è¯•è¦†ç›–ç‡
   - å“åº”ç¤¾åŒº Issues

2. **ä¸­æœŸ (3-6ä¸ªæœˆ):**
   - ä¼˜åŒ–é¡¹ç›®æ¶æ„
   - é‡æ„é«˜å¤æ‚åº¦ä»£ç 
   - æå‡ä»£ç è´¨é‡

3. **é•¿æœŸ (6-12ä¸ªæœˆ):**
   - æ‰©å¤§ç¤¾åŒºå½±å“åŠ›
   - å»ºç«‹å®Œå–„çš„è´¡çŒ®è€…æŒ‡å—
   - æŒç»­ä¼˜åŒ–æ€§èƒ½
"""

    def _assess_technical_debt(self, code_review: Dict) -> str:
        """è¯„ä¼°æŠ€æœ¯å€ºåŠ¡"""
        return f"""**æŠ€æœ¯å€ºåŠ¡è¯„ä¼°:**
- ä»£ç å¤æ‚åº¦: {code_review.get('avg_complexity', 'N/A')}
- å¾…æ”¹è¿›é—®é¢˜æ•°: {code_review.get('total_issues', 0)}
- å»ºè®®æŠ•å…¥æ—¶é—´: æ ¹æ®é—®é¢˜ä¼˜å…ˆçº§é€æ­¥æ”¹è¿›
"""

    def _generate_conclusion(self, data: Dict) -> str:
        """ç”Ÿæˆæ€»ç»“"""
        metadata = data.get('metadata', {})
        return f"""**{metadata.get('name', 'Unknown')}** é¡¹ç›®çš„æŠ€æœ¯åˆ†æå·²å®Œæˆã€‚

æ•´ä½“è€Œè¨€ï¼Œè¯¥é¡¹ç›®å±•ç°å‡ºè‰¯å¥½çš„å‘å±•æ½œåŠ›ã€‚å»ºè®®é¡¹ç›®ç»´æŠ¤è€…æ ¹æ®æœ¬æŠ¥å‘Šçš„å…·ä½“å»ºè®®ï¼Œ
æŒç»­æ”¹è¿›ä»£ç è´¨é‡ã€ä¼˜åŒ–æ¶æ„è®¾è®¡ã€å¢å¼ºç¤¾åŒºå‚ä¸åº¦ã€‚

æœ¬æŠ¥å‘Šå¯ä½œä¸ºé¡¹ç›®æ”¹è¿›çš„å‚è€ƒä¾æ®å’ŒæŠ€æœ¯å†³ç­–çš„æ”¯æŒææ–™ã€‚
"""

    # === QA æ•°æ®é›†ç”Ÿæˆ ===
    
    def _generate_qa_dataset(self, project_data: Dict) -> List[Dict]:
        """ç”Ÿæˆ QA è®­ç»ƒæ•°æ®é›†"""
        qa_pairs = []
        
        metadata = project_data.get('metadata', {})
        architecture = project_data.get('architecture', {})
        code_review = project_data.get('code_review', {})
        community = project_data.get('community', {})
        
        # 1. é¡¹ç›®åŸºæœ¬ä¿¡æ¯ç›¸å…³é—®ç­”
        qa_pairs.extend([
            {
                "question": f"{metadata.get('name')} é¡¹ç›®çš„ä¸»è¦ç¼–ç¨‹è¯­è¨€æ˜¯ä»€ä¹ˆ?",
                "answer": f"è¯¥é¡¹ç›®ä¸»è¦ä½¿ç”¨ {metadata.get('language', 'N/A')} è¯­è¨€å¼€å‘ã€‚",
                "category": "åŸºæœ¬ä¿¡æ¯"
            },
            {
                "question": f"{metadata.get('name')} é¡¹ç›®æœ‰å¤šå°‘ Stars?",
                "answer": f"è¯¥é¡¹ç›®ç›®å‰æœ‰ {metadata.get('stars', 0)} ä¸ª Starsã€‚",
                "category": "åŸºæœ¬ä¿¡æ¯"
            },
            {
                "question": f"{metadata.get('name')} é¡¹ç›®çš„æè¿°æ˜¯ä»€ä¹ˆ?",
                "answer": metadata.get('description', 'æš‚æ— æè¿°'),
                "category": "åŸºæœ¬ä¿¡æ¯"
            }
        ])
        
        # 2. æ¶æ„ç›¸å…³é—®ç­”
        core_dirs = architecture.get('core_directories', [])
        if core_dirs:
            qa_pairs.append({
                "question": f"{metadata.get('name')} é¡¹ç›®çš„æ ¸å¿ƒç›®å½•æœ‰å“ªäº›?",
                "answer": f"è¯¥é¡¹ç›®çš„æ ¸å¿ƒç›®å½•åŒ…æ‹¬: {', '.join(core_dirs)}",
                "category": "æ¶æ„"
            })
        
        # 3. ä»£ç è´¨é‡ç›¸å…³é—®ç­”
        if code_review.get('average_score'):
            qa_pairs.append({
                "question": f"{metadata.get('name')} é¡¹ç›®çš„ä»£ç è´¨é‡å¦‚ä½•?",
                "answer": f"è¯¥é¡¹ç›®çš„å¹³å‡ä»£ç è´¨é‡è¯„åˆ†ä¸º {code_review.get('average_score')}/100",
                "category": "ä»£ç è´¨é‡"
            })
        
        # 4. ç¤¾åŒºç›¸å…³é—®ç­”
        qa_pairs.extend([
            {
                "question": f"{metadata.get('name')} é¡¹ç›®çš„ç¤¾åŒºæ´»è·ƒåº¦å¦‚ä½•?",
                "answer": f"è¯¥é¡¹ç›®çš„æ´»è·ƒåº¦ç­‰çº§ä¸º: {community.get('activity_level', 'æœªçŸ¥')}",
                "category": "ç¤¾åŒº"
            },
            {
                "question": f"{metadata.get('name')} é¡¹ç›®æœ‰å¤šå°‘è´¡çŒ®è€…?",
                "answer": f"è¯¥é¡¹ç›®ç›®å‰æœ‰ {community.get('total_contributors', 0)} ä½è´¡çŒ®è€…ã€‚",
                "category": "ç¤¾åŒº"
            }
        ])
        
        # 5. é—®é¢˜å’Œæ”¹è¿›ç›¸å…³é—®ç­”
        improvements = self._identify_improvements(project_data)
        if improvements and improvements != "æ— æ˜æ˜¾å¾…æ”¹è¿›é¡¹":
            qa_pairs.append({
                "question": f"{metadata.get('name')} é¡¹ç›®æœ‰å“ªäº›éœ€è¦æ”¹è¿›çš„åœ°æ–¹?",
                "answer": improvements,
                "category": "æ”¹è¿›å»ºè®®"
            })
        
        return qa_pairs
